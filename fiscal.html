<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fiscal ‚Äî Sistema de Produ√ß√£o </title>

  <!-- Fonte & Reset visual -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --ink:#111827; --muted:#6b7280;
      --primary:#2563eb; --primary-ink:#fff; --border:#e5e7eb;
      --good:#16a34a; --bad:#dc2626; --chip:#eef2ff; --chip-ink:#1e40af;
      --warning:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--ink);
    }

    /* Header fixo */
    .header{
      position:fixed; top:0; left:0; right:0; z-index:50;
      background:#fff; border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:12px;
      padding:12px 16px;
    }
    .header .title{font-weight:700}
    .header .sub{color:var(--muted); font-size:14px}
    .header .right{margin-left:auto; display:flex; align-items:center; gap:10px}
    .btn-ghost{
      background:#eef2ff; color:#1e40af; border:0; border-radius:10px;
      padding:8px 12px; cursor:pointer; font-weight:600;
    }
    .who-badge{
      background:#f3f4f6; color:#111827; border-radius:999px; padding:6px 10px; font-size:12px; font-weight:600;
    }

    .wrap{max-width:1100px; margin:0 auto; padding:98px 16px 24px;}
    h1{font-size:22px; margin:0 0 4px}
    .sub{color:var(--muted); margin:0 0 12px}
    .msg{display:none; margin:10px 0; font-weight:600}
    .msg.ok{color:var(--good)} .msg.err{color:var(--bad)}

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; box-shadow:0 4px 14px rgba(17,24,39,.05);
      margin-bottom:16px; overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700; display:flex; align-items:center; gap:12px;
    }
    .card .bd{padding:16px}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .right{margin-left:auto}

    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input,select,button{font:inherit}
    input,select{
      width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:10px; background:#fff;
    }
    button{
      padding:10px 14px; border:0; border-radius:10px;
      background:var(--primary); color:var(--primary-ink); cursor:pointer; font-weight:600;
    }
    button.link{background:transparent; color:var(--primary); padding:0}

    .form-grid{
      display:grid; gap:12px;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    }

    /* Chips de meses */
    #mesBtns{display:flex; flex-wrap:wrap; gap:6px}
    .pill{
      background:var(--chip); color:var(--chip-ink);
      border:0; border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:600; font-size:13px;
    }
    .pill.is-active{background:var(--primary); color:#fff}

    
/* ======= TABELA OTIMIZADA PARA DESKTOP ======= */
.table-wrap{
  overflow:hidden;
}
table{
  width:100%;
  border-collapse:collapse;
  border-spacing:0;
  table-layout:fixed;
}
th, td{
  padding:10px 10px;
  border-bottom:1px solid var(--border);
  text-align:left;
  font-size:13.5px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
thead th{
  background:#f3f4f6;
  color:var(--muted);
  font-weight:600;
}
tbody tr:nth-child(even){background:#f9fafb}
tbody tr.duplicate-row{
  background:#fef3c7 !important;
  border-left: 4px solid var(--warning);
}
tfoot td{
  font-weight:700;
  background:#fafafa;
}

    /* A√ß√µes com √≠cones */
    .act{background:transparent; color:var(--primary); border:0; cursor:pointer; padding:6px}
    .act.del{color:var(--bad)}
    .act[title]{position:relative}

    /* Checkbox na tabela */
    input[type="checkbox"]{
      width:auto; cursor:pointer;
    }

    /* Bot√£o de corre√ß√£o */
    .btn-corrigir {
        padding: 6px 10px;
        font-size: 12px;
        background-color: var(--primary);
        color: var(--primary-ink);
        border: 0;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    /* Bot√£o de exclus√£o em massa */
    .btn-delete-selected {
      background: var(--bad);
      color: #fff;
      padding: 10px 14px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      display: none;
    }
    .btn-delete-selected.show {
      display: inline-block;
    }

    /* Se√ß√£o de duplicidades */
    .duplicates-section {
      margin-bottom: 20px;
      padding: 12px 16px;
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 10px;
      display: none;
    }
    .duplicates-section.show {
      display: block;
    }
    .duplicates-section h3 {
      margin: 0 0 12px;
      color: var(--warning);
      font-size: 14px;
    }
    .duplicate-group {
      background: #fff;
      border-left: 3px solid var(--warning);
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    .duplicate-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .duplicate-item:last-child {
      border-bottom: none;
    }
    .duplicate-actions {
      display: flex;
      gap: 4px;
    }
    .btn-dup-delete {
      background: var(--bad);
      color: #fff;
      padding: 4px 8px;
      border: 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }
    .btn-dup-ignore {
      background: var(--good);
      color: #fff;
      padding: 4px 8px;
      border: 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }
    .btn-dup-delete-all {
      background: var(--bad);
      color: #fff;
      padding: 10px 14px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 8px;
    }

    /* Se√ß√£o de erros no topo */
    .error-item-details { flex-grow: 1; }
    .error-item-actions { margin-left: 16px; }
    .error-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #fff;
      border-left: 3px solid var(--bad);
      margin-bottom: 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    .errors-section{
      margin-bottom:20px;
      padding:12px 16px;
      background:#fef2f2;
      border:1px solid #fecaca;
      border-radius:10px;
      display:none;
    }
    .errors-section.show{
      display:block;
    }
    .errors-section h3{
      margin:0 0 12px;
      color:var(--bad);
      font-size:14px;
    }
    .error-item:last-child{
      margin-bottom:0;
    }

  </style>
</head>
<body>
  <!-- Cabe√ßalho fixo padr√£o -->
  <header class="header">
    <div>
      <div class="title">Sistema de Produ√ß√£o Tribut√°rio ‚Äî Painel do Fiscal (Valida√ß√£o + Exclus√£o em Massa + Duplicidades)</div>
      <div class="sub">Registre seus servi√ßos, valide tipos, exclua m√∫ltiplos lan√ßamentos e detecte duplicidades</div>
    </div>
    <div class="right">
      <span id="who" class="who-badge">Conectando‚Ä¶</span>
      <button id="btnSair" class="btn-ghost">Sair</button>
    </div>
  </header>

  <div class="wrap" id="conteudo" style="display:none">
    <div id="msg" class="msg"></div>

    <!-- Lan√ßamento -->
    <div class="card">
      <div class="hd">
        <span id="tituloForm">Novo lan√ßamento</span>
        <div class="right toolbar">
          <small class="sub">Campos obrigat√≥rios: Data e Tipo de servi√ßo (Resumo)</small>
        </div>
      </div>

      <div class="bd">
        <div class="form-grid">
          <div><label>Data</label><input id="fData" type="date"></div>
          <div><label>Nome do Contribuinte</label><input id="fEmpresa" type="text" placeholder="Ex.: Empresa XPTO LTDA"></div>
          <div><label>CNPJ / CPF</label><input id="fCnpjCpf" type="text" maxlength="18" placeholder="00.000.000/0000-00 ou 000.000.000-00"></div>
          <div><label>Detalhamento do servi√ßo</label><input id="fDesc" type="text" placeholder="Ex.: emiss√£o de guia, libera√ß√£o de acesso‚Ä¶"></div>
          <div><label>Quantidade</label><input id="fQtd" type="number" min="1" step="1" value="1"></div>
          <div><label>Valor (R$)</label><input id="fValor" type="text" placeholder="R$ 0,00"></div>
          <div>
            <label>Destino</label>
            <select id="fDestino">
              <option value="">Selecione</option>
              <option value="Ger√™ncia">Ger√™ncia</option>
              <option value="Contribuinte">Contribuinte</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          <div>
            <label>Tipo de servi√ßo</label>
            <input id="fResumo" list="listaServicos" placeholder="Digite ou selecione o tipo de servi√ßo">
            <datalist id="listaServicos"></datalist>
          </div>
          <div style="align-self:end">
            <button id="btnAdd" type="button">Adicionar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card">
      <div class="hd"><span>Filtrar lan√ßamentos por m√™s e ano</span></div>
      <div class="bd">
        <div class="toolbar">
          <label for="anoFiltro">Ano:</label>
          <input id="anoFiltro" type="number" min="2020" max="2100" style="width:120px">
          <div id="mesBtns"></div>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o de Duplicidades -->
    <div id="duplicatesSection" class="duplicates-section">
      <h3>‚ö†Ô∏è Duplicidades Detectadas</h3>
      <div id="duplicatesList"></div>
      <div style="margin-top:12px">
        <button id="btnDeleteAllDuplicates" class="btn-dup-delete-all">üóëÔ∏è Excluir todas as duplicidades</button>
        <button id="btnIgnoreAllDuplicates" class="btn-dup-ignore" style="padding:10px 14px; background:var(--good)">‚úì Nenhuma duplicidade</button>
      </div>
    </div>

    <!-- Se√ß√£o de Erros (Tipos de Servi√ßo Inv√°lidos) -->
    <div id="errorsSection" class="errors-section">
      <h3>‚ö†Ô∏è Corre√ß√£o Necess√°ria - Tipos de Servi√ßo Inv√°lidos</h3>
      <div id="errorsList"></div>
    </div>

    <!-- Lista -->
    <div class="card">
      <div class="hd">
        <span>Meus lan√ßamentos</span>
        <div class="right toolbar">
          <small id="totalMes" class="sub"></small>
          <button id="btnDeleteSelected" class="btn-delete-selected">üóëÔ∏è Excluir selecionados</button>
        </div>
      </div>
      <div class="bd">
        <div class="table-wrap">
          <table id="tab" class="table">
            <thead>
              <tr>
                <th style="width:40px"><input type="checkbox" id="selectAll" title="Selecionar todos"></th>
                <th>Data</th><th>Empresa</th><th>CNPJ/CPF</th><th>Descri√ß√£o</th>
                <th>Qtd</th><th>Valor</th><th>Destino</th><th>Resumo</th><th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="10" id="tfootTotal">Total do m√™s: R$ 0,00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- =================== SCRIPT PRINCIPAL =================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, getDocs, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    import { inicializarConversor } from "./converter_xlsx.js";

    window.addEventListener('DOMContentLoaded', () => {

      const firebaseConfig = {
        apiKey: "AIzaSyANrr4R5JtJ9GmO0j-1X8-9CvBmYkC4oCI",
        authDomain: "fiscalizacao9557.firebaseapp.com",
        projectId: "fiscalizacao9557",
        storageBucket: "fiscalizacao9557.firebasestorage.app",
        messagingSenderId: "98041336495",
        appId: "1:98041336495:web:0475dfd9c0490cc0a17a5a",
        measurementId: "G-7PY1G1JTKL"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Helpers
      const $  = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const showMsg = (t, cls='ok') => {
        const m=$('#msg'); m.textContent=t; m.className='msg '+cls;
        m.style.display='block'; setTimeout(()=>m.style.display='none',2500);
      };
      const numberToBRL = n => (Number(n||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

      let sess=null, mesAtivo=null, anoAtivo=null, editandoId=null;
      const selectedIds = new Set();
      const ignoredDuplicates = new Set();

      // ======= SESS√ÉO =======
      function validarSessao(){
        try{ sess = JSON.parse(localStorage.getItem('sessao_usuario')||'null'); }catch(e){ sess=null; }
        if(!sess || sess.tipo!=='fiscal'){ location.href='index.html'; return; }
        $('#conteudo').style.display='block';
        $('#who').textContent = `${sess.nome} (Fiscal)`;
        $('#fData').value = new Date().toISOString().slice(0,10);
        $('#anoFiltro').value = new Date().getFullYear();
        anoAtivo = parseInt($('#anoFiltro').value,10);
      }
      validarSessao();

      // ======= TIPOS (datalist) =======
      const TIPOS = [
        "Apura√ß√£o de TFLF","Auto de Infra√ß√£o","Bancos TIAF (In√≠cio)","Bancos TEAF (Encerramento)",
        "Bloqueio Inscri√ß√£o/Movimenta√ß√£o","Cadastro Municipal - Inscri√ß√£o","Cadastro Municipal - Altera√ß√£o",
        "Cadastro Municipal - Baixa","Certid√£o","CFEM TIAF (In√≠cio)","CFEM TEAF (Encerramento)",
        "Curso/Treinamento (Meio Periodo)","Curso/Treinamento (Tempo Integral)","Desenquad./Mud. Regime Tribut√°rio",
        "Informa√ß√µes a Contribuintes","ISSQN Constru√ß√£o Civil","Lan√ßamento de Tributo","Levantamento ISSQN",
        "Levantamento ISSQN (Simples Nacional)","Manifesta√ß√£o em Processo","Memorando/Of√≠cio/Notifica√ß√£o/Termo",
        "Montagem de Processo","NFS-e - Libera√ß√£o de Acesso","NFS-e - Suporte","Parecer Fiscal","Plant√£o",
        "Recurso - 1¬™ Inst√¢ncia","Reenvio de Correspond√™ncia","Relat√≥rio Gerencial","Reuni√£o","RPA",
        "Servi√ßos Especiais","Servi√ßos Especiais (Sec. Fazenda)","Verifia√ß√£o de Livro Fiscal/Cont√°bil",
        "Verifica√ß√£o de NFS-e/Documentos","Viagem (por Dia)","Vistoria in loco"
      ];
      
      const datalist = $('#listaServicos');
      datalist.innerHTML='';
      TIPOS.forEach(t=>{ const o=document.createElement('option'); o.value=t; datalist.appendChild(o); });

      // ======= FUN√á√ÉO DE VALIDA√á√ÉO DE TIPO DE SERVI√áO =======
      function isValidServiceType(tipo) {
        return TIPOS.includes(tipo);
      }

      // ======= FUN√á√ÉO DE DETEC√á√ÉO DE DUPLICIDADES =======
      function detectDuplicates(lancamentos) {
        const groups = {};
        const duplicateIds = new Set();

        lancamentos.forEach(l => {
          const key = `${l.data}|${l.empresa}|${l.cnpj}|${l.descricao}|${l.quantidade}|${l.valor}|${l.descricaoResumida}`;
          if (!groups[key]) {
            groups[key] = [];
          }
          groups[key].push(l);
        });

        Object.values(groups).forEach(group => {
          if (group.length > 1) {
            group.forEach(item => duplicateIds.add(item.id));
          }
        });

        return { groups, duplicateIds };
      }

      // ======= M√ÅSCARAS =======
      const cnpjEl = $('#fCnpjCpf');
      cnpjEl.addEventListener('input', ()=>{
        let v = cnpjEl.value.replace(/\D/g,'');
        if (v.length<=11){
          v = v.replace(/(\d{3})(\d)/,'$1.$2')
               .replace(/(\d{3})(\d)/,'$1.$2')
               .replace(/(\d{3})(\d{1,2})$/,'$1-$2');
        }else{
          v = v.replace(/(\d{2})(\d)/,'$1.$2')
               .replace(/(\d{3})(\d)/,'$1.$2')
               .replace(/(\d{3})(\d)/,'$1/$2')
               .replace(/(\d{4})(\d{1,2})$/,'$1-$2');
        }
        cnpjEl.value = v;
      });

      $('#fValor').addEventListener('input', e=>{
        let v = e.target.value.replace(/\D/g,'');
        v = (v/100).toFixed(2)+''; v = v.replace('.',',');
        v = v.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
        e.target.value = 'R$ '+v;
      });

      // ======= MESES (chips) =======
      const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
      const mesBtns = $('#mesBtns');
      meses.forEach((m,i)=>{
        const b = document.createElement('button');
        b.textContent=m; b.className='pill';
        b.onclick=()=>{
          $$('#mesBtns .pill').forEach(x=>x.classList.remove('is-active'));
          b.classList.add('is-active');
          mesAtivo=i+1; anoAtivo=parseInt($('#anoFiltro').value,10);
          renderMeus();
        };
        mesBtns.appendChild(b);
      });

      // ======= ADICIONAR / EDITAR =======
      $('#btnAdd').onclick = async ()=>{
        const d = $('#fData').value,
              empresa = $('#fEmpresa').value.trim(),
              cnpjcpf = $('#fCnpjCpf').value.trim(),
              desc = $('#fDesc').value.trim(),
              qtd = parseInt($('#fQtd').value||'1',10),
              valor = parseFloat($('#fValor').value.replace(/[^\d,]/g,'').replace(',','.'))||0,
              destino = $('#fDestino').value,
              resumo = $('#fResumo').value;
        if(!d || !resumo){ showMsg('Informe a Data e o Tipo de servi√ßo.','err'); return; }

        try{
          if(editandoId){
            await updateDoc(doc(db,'lancamentos',editandoId), {
              data:d, empresa, cnpj:cnpjcpf, descricao:desc,
              quantidade:qtd, valor, destino, descricaoResumida:resumo
            });
            showMsg('Lan√ßamento atualizado.','ok');
            editandoId=null;
            $('#tituloForm').textContent='Novo lan√ßamento';
            $('#btnAdd').textContent='Adicionar';
          }else{
            await addDoc(collection(db,'lancamentos'), {
              usuario:sess.nome, data:d, empresa, cnpj:cnpjcpf, descricao:desc,
              quantidade:qtd, valor, destino, descricaoResumida:resumo, criadoEm:serverTimestamp()
            });
            showMsg('Lan√ßamento salvo.','ok');
          }
          // limpar campos
          $('#fEmpresa').value=$('#fCnpjCpf').value=$('#fDesc').value=$('#fValor').value='';
          $('#fQtd').value='1'; $('#fDestino').value=''; $('#fResumo').value='';
          $('#fEmpresa').focus();
          renderMeus();
        }catch(e){ console.error(e); showMsg('Erro ao salvar.','err'); }
      };

      // ======= LISTAR COM VALIDA√á√ÉO E DUPLICIDADES =======
      async function renderMeus(){
        if(!sess) return;
        const q = query(collection(db,'lancamentos'), where('usuario','==',sess.nome), orderBy('data','desc'));
        const snap = await getDocs(q);
        const tbody = document.querySelector('#tab tbody');
        tbody.innerHTML='';
        let soma = 0;

        // Primeiro, processa todos os lan√ßamentos
        const lancamentos = [];
        snap.forEach(docSnap=>{
          const r = docSnap.data();
          const [y,mm,dd]=(r.data||'').split('-');
          if(anoAtivo && parseInt(y)!=anoAtivo) return;
          if(mesAtivo && parseInt(mm)!=mesAtivo) return;
          soma += Number(r.valor||0);

          lancamentos.push({
            id: docSnap.id,
            data: r.data,
            dd, mm, y,
            empresa: r.empresa,
            cnpj: r.cnpj,
            descricao: r.descricao,
            quantidade: r.quantidade,
            valor: r.valor,
            destino: r.destino,
            descricaoResumida: r.descricaoResumida,
            isValid: isValidServiceType(r.descricaoResumida)
          });
        });

        // Detecta duplicidades
        const { groups, duplicateIds } = detectDuplicates(lancamentos.filter(l => l.isValid));
        const duplicatesFiltered = Array.from(duplicateIds).filter(id => !ignoredDuplicates.has(id));

        // Renderiza apenas os lan√ßamentos v√°lidos na tabela principal
        lancamentos.filter(l => l.isValid).forEach(r => {
          const tr=document.createElement('tr');
          if(duplicatesFiltered.includes(r.id)) {
            tr.classList.add('duplicate-row');
          }
          tr.innerHTML=`
            <td style="width:40px"><input type="checkbox" class="row-checkbox" data-id="${r.id}"></td>
            <td>${r.dd}-${r.mm}-${r.y}</td>
            <td title="${r.empresa||''}">${r.empresa||''}</td>
            <td>${r.cnpj||''}</td>
            <td title="${r.descricao||''}">${r.descricao||''}</td>
            <td>${r.quantidade||0}</td>
            <td>${numberToBRL(r.valor)}</td>
            <td>${r.destino||''}</td>
            <td>${r.descricaoResumida||''}</td>
            <td style="white-space:nowrap">
              <button class="act" title="Editar" data-edit="${r.id}">‚úèÔ∏è</button>
              <button class="act del" title="Excluir" data-del="${r.id}">üóëÔ∏è</button>
            </td>`;
          tbody.appendChild(tr);
        });

        // Exibe a se√ß√£o de duplicidades se houver
        const duplicatesSection = $('#duplicatesSection');
        const duplicatesList = $('#duplicatesList');
        if(duplicatesFiltered.length > 0){
          duplicatesSection.classList.add('show');
          let html = '';
          Object.entries(groups).forEach(([key, group]) => {
            const hasIgnored = group.some(l => ignoredDuplicates.has(l.id));
            if(group.length > 1 && !hasIgnored) {
              html += `<div class="duplicate-group">
                <strong>Duplicidade encontrada:</strong> ${group[0].empresa} - ${group[0].descricaoResumida}<br>
                <small>Data: ${group[0].dd}-${group[0].mm}-${group[0].y} | Valor: ${numberToBRL(group[0].valor)} | Qtd: ${group[0].quantidade}</small>`;
              group.forEach(item => {
                html += `<div class="duplicate-item">
                  <span>ID: ${item.id.substring(0,8)}...</span>
                  <div class="duplicate-actions">
                    <button class="btn-dup-delete" data-delete-dup="${item.id}">Excluir</button>
                    <button class="btn-dup-ignore" data-ignore-dup="${item.id}">N√£o √© duplicidade</button>
                  </div>
                </div>`;
              });
              html += '</div>';
            }
          });
          duplicatesList.innerHTML = html;
        }else{
          duplicatesSection.classList.remove('show');
          duplicatesList.innerHTML = '';
        }

        // Filtra os lan√ßamentos inv√°lidos
        const lancamentosInvalidos = lancamentos.filter(l => !l.isValid);

        // Exibe a se√ß√£o de erros se houver
        const errorsSection = $('#errorsSection');
        const errorsList = $('#errorsList');
        if(lancamentosInvalidos.length > 0){
          errorsSection.classList.add('show');
          errorsList.innerHTML = lancamentosInvalidos.map(e => `
            <div class="error-item">
              <div class="error-item-details">
                <strong>${e.empresa}</strong> ‚Äî Tipo inv√°lido: "<strong>${e.descricaoResumida}</strong>"
                <br><small>Corre√ß√£o necess√°ria! - Escolha um tipo de servi√ßo v√°lido. (Observa√ß√£o: Aproveite para revisar todos os campos)</small>
              </div>
              <div class="error-item-actions">
                  <button class="btn-corrigir" data-edit="${e.id}">Corrigir</button>
              </div>
            </div>
          `).join('');
        }else{
          errorsSection.classList.remove('show');
          errorsList.innerHTML = '';
        }

        // ======= ORDENAR TABELA LOCALMENTE =======
        const headers = document.querySelectorAll('#tab thead th');
        headers.forEach((th, idx) => {
          if(idx === 0) return;
          th.style.cursor = 'pointer';
          th.title = 'Clique para ordenar';
          th.onclick = () => ordenarTabela(idx);
        });

        let thUltimo = null, ascUltima = true;

        function ordenarTabela(colIndex) {
          const tbody = document.querySelector('#tab tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const asc = thUltimo !== colIndex ? true : !ascUltima;
          thUltimo = colIndex;
          ascUltima = asc;

          rows.sort((a, b) => {
            let A = a.children[colIndex].innerText.trim();
            let B = b.children[colIndex].innerText.trim();

            const parseBRL = v => parseFloat(v.replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            if (A.includes('R$') || B.includes('R$')) {
              A = parseBRL(A);
              B = parseBRL(B);
              return asc ? A - B : B - A;
            }

            const parseDate = v => {
              const parts = v.split(/[-/]/);
              if (parts.length === 3) {
                const [d, m, y] = parts.map(n => parseInt(n, 10));
                if (!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m - 1, d).getTime();
              }
              return null;
            };
            const dateA = parseDate(A);
            const dateB = parseDate(B);
            if (dateA && dateB) return asc ? dateA - dateB : dateB - dateA;

            const numA = parseFloat(A.replace(',', '.'));
            const numB = parseFloat(B.replace(',', '.'));
            if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;

            return asc ? A.localeCompare(B) : B.localeCompare(A);
          });

          rows.forEach(r => tbody.appendChild(r));
        }

        // Totais
        $('#tfootTotal').textContent = `Total do m√™s: ${numberToBRL(soma)}`;
        $('#totalMes').textContent = `Total filtrado: ${numberToBRL(soma)}`;

        // Limpar sele√ß√£o anterior
        selectedIds.clear();
        updateDeleteButton();

        // Anexa os eventos de clique aos bot√µes 'Editar' e 'Corrigir'
        attachEditListeners();

        // Anexa eventos aos checkboxes
        attachCheckboxListeners();

        // Anexa eventos aos bot√µes de duplicidades
        attachDuplicateListeners();
        
        // Excluir individual
        document.querySelectorAll('[data-del]').forEach(btn=>{
          btn.onclick=async ()=>{
            if(confirm('Deseja excluir este lan√ßamento?')){
              await deleteDoc(doc(db,'lancamentos',btn.getAttribute('data-del')));
              showMsg('Lan√ßamento exclu√≠do.','ok');
              renderMeus();
            }
          };
        });
      }

      // ======= GERENCIAR CHECKBOXES =======
      function attachCheckboxListeners(){
        const selectAllCheckbox = $('#selectAll');
        const rowCheckboxes = $$('.row-checkbox');

        selectAllCheckbox.addEventListener('change', ()=>{
          rowCheckboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
            if(selectAllCheckbox.checked){
              selectedIds.add(cb.getAttribute('data-id'));
            }else{
              selectedIds.delete(cb.getAttribute('data-id'));
            }
          });
          updateDeleteButton();
        });

        rowCheckboxes.forEach(cb => {
          cb.addEventListener('change', ()=>{
            if(cb.checked){
              selectedIds.add(cb.getAttribute('data-id'));
            }else{
              selectedIds.delete(cb.getAttribute('data-id'));
              selectAllCheckbox.checked = false;
            }
            updateDeleteButton();
          });
        });
      }

      // ======= ATUALIZAR BOT√ÉO DE EXCLUS√ÉO =======
      function updateDeleteButton(){
        const btn = $('#btnDeleteSelected');
        if(selectedIds.size > 0){
          btn.classList.add('show');
          btn.textContent = `üóëÔ∏è Excluir ${selectedIds.size} selecionado(s)`;
        }else{
          btn.classList.remove('show');
        }
      }

      // ======= EXCLUS√ÉO EM MASSA =======
      $('#btnDeleteSelected').onclick = async ()=>{
        if(selectedIds.size === 0) return;
        if(!confirm(`Deseja excluir ${selectedIds.size} lan√ßamento(s)? Esta a√ß√£o n√£o pode ser desfeita.`)) return;

        try{
          for(const id of selectedIds){
            await deleteDoc(doc(db,'lancamentos',id));
          }
          showMsg(`${selectedIds.size} lan√ßamento(s) exclu√≠do(s).`,'ok');
          selectedIds.clear();
          renderMeus();
        }catch(e){
          console.error(e);
          showMsg('Erro ao excluir lan√ßamentos.','err');
        }
      };

      // ======= GERENCIAR DUPLICIDADES =======
      function attachDuplicateListeners(){
        document.querySelectorAll('[data-delete-dup]').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-delete-dup');
            if(confirm('Deseja excluir esta duplicidade?')){
              await deleteDoc(doc(db,'lancamentos',id));
              showMsg('Duplicidade exclu√≠da.','ok');
              renderMeus();
            }
          };
        });

        document.querySelectorAll('[data-ignore-dup]').forEach(btn=>{
          btn.onclick = ()=>{
            const id = btn.getAttribute('data-ignore-dup');
            ignoredDuplicates.add(id);
            showMsg('Marcado como n√£o duplicidade.','ok');
            renderMeus();
          };
        });
      }

      // ======= EXCLUIR TODAS AS DUPLICIDADES (mantendo um registro) =======
      $('#btnDeleteAllDuplicates').onclick = async ()=>{
        // Recarrega os lan√ßamentos para obter os dados atualizados
        const q = query(collection(db,'lancamentos'), where('usuario','==',sess.nome), orderBy('data','desc'));
        const snap = await getDocs(q);
        const lancamentos = [];
        snap.forEach(docSnap=>{
          const r = docSnap.data();
          lancamentos.push({
            id: docSnap.id,
            data: r.data,
            empresa: r.empresa,
            cnpj: r.cnpj,
            descricao: r.descricao,
            quantidade: r.quantidade,
            valor: r.valor,
            descricaoResumida: r.descricaoResumida
          });
        });

        // Detecta duplicidades
        const { groups } = detectDuplicates(lancamentos);
        const idsToDelete = [];
        let countToDelete = 0;

        // Para cada grupo de duplicidades, mant√©m o primeiro e marca os outros para exclus√£o
        Object.values(groups).forEach(group => {
          if(group.length > 1){
            // Mant√©m o primeiro (mais antigo ou primeiro na lista)
            for(let i = 1; i < group.length; i++){
              idsToDelete.push(group[i].id);
              countToDelete++;
            }
          }
        });

        if(idsToDelete.length === 0){
          showMsg('Nenhuma duplicidade para excluir.','ok');
          return;
        }

        if(!confirm(`Deseja excluir ${countToDelete} c√≥pia(s) de duplicidade(s)? Ser√° mantido um registro de cada grupo. Esta a√ß√£o n√£o pode ser desfeita.`)) return;

        try{
          for(const id of idsToDelete){
            await deleteDoc(doc(db,'lancamentos',id));
          }
          showMsg(`${countToDelete} c√≥pia(s) de duplicidade(s) exclu√≠da(s). Um registro de cada grupo foi mantido.`,'ok');
          renderMeus();
        }catch(e){
          console.error(e);
          showMsg('Erro ao excluir duplicidades.','err');
        }
      };

      // ======= IGNORAR TODAS AS DUPLICIDADES =======
      $('#btnIgnoreAllDuplicates').onclick = ()=>{
        $$('[data-ignore-dup]').forEach(btn => {
          const id = btn.getAttribute('data-ignore-dup');
          ignoredDuplicates.add(id);
        });
        showMsg('Todas marcadas como n√£o duplicidades.','ok');
        renderMeus();
      };

      // Fun√ß√£o para anexar os listeners de edi√ß√£o
      function attachEditListeners(){
        document.querySelectorAll('[data-edit]').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-edit');
            const lancSnap = await getDocs(query(collection(db,'lancamentos'), where('__name__','==',id)));
            if(!lancSnap.empty){
              const r = lancSnap.docs[0].data();
              $('#fData').value=r.data||'';
              $('#fEmpresa').value=r.empresa||'';
              $('#fCnpjCpf').value=r.cnpj||'';
              $('#fDesc').value=r.descricao||'';
              $('#fQtd').value=r.quantidade||1;
              $('#fValor').value=r.valor?'R$ '+Number(r.valor).toFixed(2).replace('.',','):'';
              $('#fDestino').value=r.destino||'';
              $('#fResumo').value=r.descricaoResumida||'';
              editandoId=id;
              $('#tituloForm').textContent='Editar lan√ßamento';
              $('#btnAdd').textContent='Salvar altera√ß√µes';
              showMsg('Corrigindo lan√ßamento... Aproveite para revisar todos os campos.', 'ok');
              window.scrollTo({top:0, behavior:'smooth'});
            }
          };
        });
      }

      renderMeus();

      // üß© Inicializa o bot√£o "Converter texto copiado"
      inicializarConversor(db, sess, addDoc, collection, serverTimestamp, renderMeus, showMsg);

      // Sair
      $('#btnSair').onclick=()=>{ localStorage.removeItem('sessao_usuario'); location.href='index.html'; };
    });
  </script>
</body>
</html>
