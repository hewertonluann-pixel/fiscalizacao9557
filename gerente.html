<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerente ‚Äî Sistema de Produ√ß√£o</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Painel do Gerente</h1>
  <div class="sub">
    Relat√≥rios e gest√£o de usu√°rios.
    <span id="who"></span> |
    <button id="btnSair" class="link">Sair</button>
  </div>

  <div id="msg" class="msg"></div>

  <!-- =================== RELAT√ìRIOS =================== -->
  <div class="card">
    <div class="hd">
      <span>Relat√≥rio por per√≠odo</span>
      <div class="form-grid">
        <div><label>De</label><input id="dIni" type="date"></div>
        <div><label>At√©</label><input id="dFim" type="date"></div>
        <div><label>&nbsp;</label><button id="btnFiltrar">Filtrar</button></div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="pill">Atalhos:</span>
          <button class="pill" id="pSem">Semanal</button>
          <button class="pill" id="pQzn">Quinzenal</button>
          <button class="pill" id="pMns">Mensal</button>
        </div>
      </div>
    </div>

    <div class="bd">
      <div class="scroll table-wrap">
        <table id="tabLanc" class="table">
          <thead>
            <tr>
              <th>Data</th><th>Fiscal</th><th>Empresa</th><th>Descri√ß√£o</th>
              <th>Qtd</th><th>Valor</th><th>Destino</th><th>Resumo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px">
        <div><strong>Total registros:</strong> <span id="tRegs">0</span></div>
        <div><strong>Total Quantidade:</strong> <span id="tQtd">0</span></div>
        <div><strong>Total Valor:</strong> <span id="tVal">R$ 0,00</span></div>
      </div>

      <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <label for="numRel" style="font-weight:600;">N¬∫ Relat√≥rio:</label>
        <input id="numRel" type="number" min="1" placeholder="(autom√°tico)" style="width:120px;padding:6px 8px;border:1px solid #ccc;border-radius:6px;">
        <button id="btnPDF" class="pill" style="background:#10b981;color:#fff">üñ®Ô∏è Gerar Relat√≥rio PDF</button>
      </div>

      <div style="margin-top:20px">
        <h3>Resumo por Fiscal</h3>
        <div id="resFiscal"></div>
        <h3>Resumo por Tipo de Servi√ßo</h3>
        <div id="resTipo"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // =================== FIREBASE ===================
  const firebaseConfig = {
    apiKey: "AIzaSyANrr4R5JtJ9GmO0j-1X8-9CvBmYkC4oCI",
    authDomain: "fiscalizacao9557.firebaseapp.com",
    projectId: "fiscalizacao9557",
    storageBucket: "fiscalizacao9557.firebasestorage.app",
    messagingSenderId: "98041336495",
    appId: "1:98041336495:web:0475dfd9c0490cc0a17a5a",
    measurementId: "G-7PY1G1JTKL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // =================== UTIL ===================
  const $ = s => document.querySelector(s);
  const numberToBRL = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const showMsg = (t,c='ok')=>{ const m=$('#msg'); m.textContent=t; m.className='msg '+c; m.style.display='block'; setTimeout(()=>m.style.display='none',2500); };

  // =================== SESS√ÉO ===================
  let sess=null;
  function validarSessao(){
    try{ sess = JSON.parse(localStorage.getItem('sessao_usuario')||'null'); }catch(e){ sess=null; }
    if(!sess || sess.tipo!=='gerente'){ location.href='index.html'; return; }
    $('#who').textContent = `${sess.nome} (Gerente)`;
  }
  validarSessao();
  $('#btnSair').onclick=()=>{ localStorage.removeItem('sessao_usuario'); location.href='index.html'; };

  // =================== FILTRAR LAN√áAMENTOS ===================
  let cacheLanc = [];

  function setPeriodo(dias){
    const fim=new Date(), ini=new Date(); ini.setDate(ini.getDate()-dias+1);
    $('#dIni').value = ini.toISOString().slice(0,10);
    $('#dFim').value = fim.toISOString().slice(0,10);
  }

  $('#pSem').onclick=()=>{ setPeriodo(7); filtrar(); };
  $('#pQzn').onclick=()=>{ setPeriodo(15); filtrar(); };
  $('#pMns').onclick=()=>{ setPeriodo(30); filtrar(); };
  $('#btnFiltrar').onclick=filtrar;

  async function filtrar(){
    const dIni = $('#dIni').value, dFim = $('#dFim').value;
    if(!dIni || !dFim){ showMsg('Informe o per√≠odo.','err'); return; }

    const qLanc = query(
      collection(db,'lancamentos'),
      where('data','>=', dIni),
      where('data','<=', dFim),
      orderBy('data','asc')
    );
    const snap = await getDocs(qLanc);
    cacheLanc = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderLanc(cacheLanc);
  }

  function renderLanc(rows){
    const tb=$('#tabLanc tbody'); tb.innerHTML='';
    let tRegs=0,tQtd=0,tVal=0;
    const porFiscal=new Map(), porTipo=new Map();

    rows.forEach(r=>{
      tRegs++; tQtd += Number(r.quantidade||0); tVal += Number(r.valor||0);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.data||''}</td><td>${r.usuario||''}</td><td>${r.empresa||''}</td><td>${r.descricao||''}</td>
                      <td>${r.quantidade||0}</td><td>${r.valor?numberToBRL(r.valor):''}</td><td>${r.destino||''}</td><td>${r.descricaoResumida||''}</td>`;
      tb.appendChild(tr);
      porFiscal.set(r.usuario,(porFiscal.get(r.usuario)||0)+Number(r.quantidade||0));
      porTipo.set(r.descricaoResumida,(porTipo.get(r.descricaoResumida)||0)+Number(r.quantidade||0));
    });

    $('#tRegs').textContent=tRegs;
    $('#tQtd').textContent=tQtd;
    $('#tVal').textContent=numberToBRL(tVal);
    $('#resFiscal').innerHTML = Array.from(porFiscal.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('') || '<em>‚Äî</em>';
    $('#resTipo').innerHTML = Array.from(porTipo.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('') || '<em>‚Äî</em>';
  }

  // =================== PDF (C√ìDIGO SEPARADO) ===================
  async function gerarPDF(){
    const dIni = $('#dIni').value, dFim = $('#dFim').value;
    if(!dIni || !dFim){ alert('Informe o per√≠odo.'); return; }
    if(cacheLanc.length===0){ alert('Nenhum dado carregado.'); return; }

    const filtrado = cacheLanc.filter(r=>{
      const d = new Date(r.data);
      return (!dIni || d>=new Date(dIni)) && (!dFim || d<=new Date(dFim));
    });

    if(filtrado.length===0){ alert('Nenhum lan√ßamento no per√≠odo.'); return; }

    // Agrupamento por Fiscal
    const porFiscal = {};
    filtrado.forEach(r=>{
      if(!porFiscal[r.usuario]) porFiscal[r.usuario] = {};
      porFiscal[r.usuario][r.descricaoResumida] = (porFiscal[r.usuario][r.descricaoResumida]||0) + Number(r.quantidade||0);
    });

    // Totais
    let totalGeral = 0, totalArrec = 0;
    filtrado.forEach(r=>{
      totalGeral += Number(r.quantidade||0);
      totalArrec += Number(r.valor||0);
    });

    const dataGer = new Date().toLocaleDateString('pt-BR');
    const ano = new Date().getFullYear();
    const gerente = sess.nome;
    const totalBRL = numberToBRL(totalArrec);
    const formatarData = d=>new Date(d+'T00:00:00').toLocaleDateString('pt-BR');
    const periodo = `${formatarData(dIni)} a ${formatarData(dFim)}`;

    // Conte√∫do HTML
    let blocos = Object.entries(porFiscal).map(([fiscal, servicos])=>{
      const linhas = Object.entries(servicos).map(([s,q])=>
        `<tr><td style="border-bottom:1px dotted #999;padding:4px 6px;">${s}</td><td style="text-align:right;border-bottom:1px dotted #999;padding:4px 6px;">${q}</td></tr>`
      ).join('');
      return `<h4 style="margin-top:20px;">${fiscal}</h4><table style="width:100%;border-collapse:collapse;margin-top:6px;">${linhas}</table>`;
    }).join('');

    const relatorio = `
    <div style="font-family:Arial;max-width:750px;margin:0 auto;line-height:1.5;word-wrap:break-word;">
      <h3 style="text-align:center;margin:0;">PREFEITURA MUNICIPAL DE DIAMANTINA</h3>
      <h4 style="text-align:center;margin:0;">SECRETARIA MUNICIPAL DE FAZENDA</h4>
      <h4 style="text-align:center;margin:0;">Diretoria de Fiscaliza√ß√£o e Tributa√ß√£o</h4>
      <hr style="margin:6px 0;">
      <h3 style="text-align:center;margin:0;">RELAT√ìRIO PRODUTIVIDADE ${ano}</h3>
      <p><strong>DE:</strong> Diretoria de Fiscaliza√ß√£o e Tributa√ß√£o<br>
      <strong>PARA:</strong> Secretaria da Fazenda<br>
      <strong>ASSUNTO:</strong> Produtividade Fiscal<br>
      <strong>DATA:</strong> ${dataGer}</p>
      <p style="margin-top:12px;">Atividades realizadas entre <strong>${periodo}</strong>:</p>
      ${blocos}
      <p style="margin-top:20px;"><strong>Total geral:</strong> ${totalGeral} atividades<br>
      <strong>Valor arrecadado:</strong> ${totalBRL}</p>
      <p style="margin-top:30px;text-align:center;">Atenciosamente,<br><br><strong>Ger√™ncia de Fiscaliza√ß√£o Tribut√°ria</strong><br>Prefeitura Municipal de Diamantina/MG</p>
      <hr style="margin:20px 0;">
      <p style="text-align:center;font-size:12px;"><strong>Gerente:</strong> ${gerente} ‚Äî ${dataGer}</p>
    </div>`;

    html2pdf().set({
      margin: [0,10,5,10],
      filename: `Relatorio_${ano}.pdf`,
      image: { type: 'jpeg', quality: 1 },
      html2canvas: { scale: 1.5, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(relatorio).save();
  }

  $('#btnPDF').onclick = gerarPDF;

  // =================== INICIAL ===================
  (function init(){
    setPeriodo(7);
    filtrar();
  })();
</script>
</body>
</html>
