<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerente ‚Äî Sistema de Produ√ß√£o</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Painel do Gerente</h1>
  <div class="sub">
    Relat√≥rios e gest√£o de usu√°rios.
    <span id="who"></span> |
    <button id="btnSair" class="link">Sair</button>
  </div>

  <div id="msg" class="msg"></div>

  <!-- =================== RELAT√ìRIOS =================== -->
  <div class="card">
    <div class="hd">
      <span>Relat√≥rio por per√≠odo</span>
      <div class="form-grid">
        <div><label>De</label><input id="dIni" type="date"></div>
        <div><label>At√©</label><input id="dFim" type="date"></div>
        <div><label>&nbsp;</label><button id="btnFiltrar">Filtrar</button></div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="pill">Atalhos:</span>
          <button class="pill" id="pSem">Semanal</button>
          <button class="pill" id="pQzn">Quinzenal</button>
          <button class="pill" id="pMns">Mensal</button>
        </div>
      </div>
    </div>

    <div class="bd">
      <div class="scroll table-wrap">
        <table id="tabLanc" class="table">
          <thead>
            <tr>
              <th>Data</th><th>Fiscal</th><th>Empresa</th><th>Descri√ß√£o</th>
              <th>Qtd</th><th>Valor</th><th>Destino</th><th>Resumo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px">
        <div><strong>Total registros:</strong> <span id="tRegs">0</span></div>
        <div><strong>Total Quantidade:</strong> <span id="tQtd">0</span></div>
        <div><strong>Total Valor:</strong> <span id="tVal">R$ 0,00</span></div>
      </div>

      <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <label for="numRel" style="font-weight:600;">N¬∫ Relat√≥rio:</label>
        <input id="numRel" type="number" min="1" placeholder="(autom√°tico)" style="width:120px;padding:6px 8px;border:1px solid #ccc;border-radius:6px;">
        <button id="btnPDF" class="pill" style="background:#10b981;color:#fff">üñ®Ô∏è Gerar Relat√≥rio PDF (modelo oficial)</button>
      </div>

      <div style="margin-top:20px">
        <h3>Resumo por Fiscal</h3>
        <div id="resFiscal"></div>
        <h3>Resumo por Tipo de Servi√ßo</h3>
        <div id="resTipo"></div>
      </div>
    </div>
  </div>

  <!-- =================== GEST√ÉO DE USU√ÅRIOS =================== -->
  <div class="card">
    <div class="hd">
      <span>Gest√£o de usu√°rios (Fiscais e Gerentes)</span>
      <button id="btnNovo" class="pill">‚ûï Novo Usu√°rio</button>
    </div>
    <div class="bd">
      <div class="scroll table-wrap">
        <table id="tabUsers" class="table">
          <thead><tr><th>Nome</th><th>Tipo</th><th>Senha</th><th>A√ß√µes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <div class="form-grid">
        <div>
          <label>Importar planilhas (.xlsx) por Fiscal (nome-do-fiscal-*.xlsx)</label>
          <input id="fileInput" type="file" multiple accept=".xlsx,.xls">
        </div>
        <div><button id="btnImportar">Importar</button></div>
        <pre id="importLog" style="white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>
</div>

<!-- Modal usu√°rio -->
<div id="modalUser" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;">
  <div style="background:#fff;padding:20px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 4px 12px rgba(0,0,0,.3);">
    <h3 id="modalTitulo">Novo Usu√°rio</h3>
    <div style="display:grid;gap:10px;margin-top:10px">
      <div><label>Nome</label><input id="uNome" type="text"></div>
      <div><label>Senha</label><input id="uSenha" type="password"></div>
      <div><label>Tipo</label>
        <select id="uTipo">
          <option value="fiscal">Fiscal</option>
          <option value="gerente">Gerente</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button id="btnSalvarUser">Salvar</button>
        <button id="btnCancelarUser" class="ghost">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyANrr4R5JtJ9GmO0j-1X8-9CvBmYkC4oCI",
    authDomain: "fiscalizacao9557.firebaseapp.com",
    projectId: "fiscalizacao9557",
    storageBucket: "fiscalizacao9557.firebasestorage.app",
    messagingSenderId: "98041336495",
    appId: "1:98041336495:web:0475dfd9c0490cc0a17a5a",
    measurementId: "G-7PY1G1JTKL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = s => document.querySelector(s);
  const numberToBRL = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const showMsg = (t,c='ok')=>{ const m=$('#msg'); m.textContent=t; m.className='msg '+c; m.style.display='block'; setTimeout(()=>m.style.display='none',2500); };

  // Sess√£o
  let sess=null;
  function validarSessao(){
    try{ sess = JSON.parse(localStorage.getItem('sessao_usuario')||'null'); }catch(e){ sess=null; }
    if(!sess || sess.tipo!=='gerente'){ location.href='index.html'; return; }
    $('#who').textContent = `${sess.nome} (Gerente)`;
  }
  validarSessao();
  $('#btnSair').onclick = ()=>{ localStorage.removeItem('sessao_usuario'); location.href='index.html'; };

  // ===== Atalhos =====
  function setPeriodo(dias){
    const fim=new Date(), ini=new Date(); ini.setDate(ini.getDate()-dias+1);
    $('#dIni').value = ini.toISOString().slice(0,10);
    $('#dFim').value = fim.toISOString().slice(0,10);
  }
  $('#pSem').onclick=()=>{ setPeriodo(7); filtrar(); };
  $('#pQzn').onclick=()=>{ setPeriodo(15); filtrar(); };
  $('#pMns').onclick=()=>{ setPeriodo(30); filtrar(); };
  $('#btnFiltrar').onclick=filtrar;

  // ===== Dados =====
  let cacheLanc = [];
  async function filtrar(){
    const q = query(collection(db,'lancamentos'), orderBy('data','asc'));
    const snap = await getDocs(q);
    cacheLanc = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderLanc(cacheLanc);
  }

  function renderLanc(rows){
    const tb=$('#tabLanc tbody'); tb.innerHTML='';
    let tRegs=0,tQtd=0,tVal=0;
    const porFiscal=new Map(), porTipo=new Map();

    rows.forEach(r=>{
      tRegs++; tQtd += Number(r.quantidade||0); tVal += Number(r.valor||0);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.data||''}</td><td>${r.usuario||''}</td><td>${r.empresa||''}</td><td>${r.descricao||''}</td>
                      <td>${r.quantidade||0}</td><td>${r.valor?numberToBRL(r.valor):''}</td><td>${r.destino||''}</td><td>${r.descricaoResumida||''}</td>`;
      tb.appendChild(tr);
      porFiscal.set(r.usuario,(porFiscal.get(r.usuario)||0)+Number(r.quantidade||0));
      porTipo.set(r.descricaoResumida,(porTipo.get(r.descricaoResumida)||0)+Number(r.quantidade||0));
    });

    $('#tRegs').textContent=tRegs;
    $('#tQtd').textContent=tQtd;
    $('#tVal').textContent=numberToBRL(tVal);
    $('#resFiscal').innerHTML = Array.from(porFiscal.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('') || '<em>‚Äî</em>';
    $('#resTipo').innerHTML = Array.from(porTipo.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('') || '<em>‚Äî</em>';
  }

  function loadLanc(){ return cacheLanc; }

  // ================= RELAT√ìRIO PDF =================
  $('#btnPDF').onclick = ()=>{
    const dIni = $('#dIni').value;
    const dFim = $('#dFim').value;
    const all = loadLanc();
    const filtrado = all.filter(r=>{
      if(!r.data) return false;
      const d = new Date(r.data);
      const di = dIni? new Date(dIni): null;
      const df = dFim? new Date(dFim): null;
      if(di && d<di) return false;
      if(df && d>df) return false;
      return true;
    });

    if(filtrado.length===0){ alert('Nenhum lan√ßamento no per√≠odo.'); return; }

    const resumo = {};
    let totalArrecadado = 0;
    filtrado.forEach(r=>{
      resumo[r.descricaoResumida] = (resumo[r.descricaoResumida]||0) + Number(r.quantidade||0);
      totalArrecadado += Number(r.valor||0);
    });

    let numInput = parseInt($('#numRel')?.value.trim() || '0');
    let num = numInput > 0 ? numInput : (Number(localStorage.getItem('numero_relatorio')||'0') + 1);
    if(numInput <= 0) localStorage.setItem('numero_relatorio', num);

    const formatarDataBR = d => d ? new Date(d + 'T00:00:00').toLocaleDateString('pt-BR') : '‚Äî';
    const dIniFmt = formatarDataBR(dIni);
    const dFimFmt = formatarDataBR(dFim);

    const hoje = new Date();
    const dataGer = hoje.toLocaleDateString('pt-BR');
    const ano = hoje.getFullYear();
    const periodo = `${dIniFmt} a ${dFimFmt}`;
    const gerente = sess.nome;
    const totalBRL = numberToBRL(totalArrecadado);

    const relatorio = `
    <div style="font-family:Arial;max-width:750px;margin:auto;line-height:1.6;word-wrap:break-word;">
      <h3 style="text-align:center;margin:0;">PREFEITURA MUNICIPAL DE DIAMANTINA</h3>
      <h4 style="text-align:center;margin:0;">SECRETARIA MUNICIPAL DE FAZENDA</h4>
      <h4 style="text-align:center;margin:0;">Diretoria de Fiscaliza√ß√£o e Tributa√ß√£o</h4>
      <hr style="margin:10px 0;">
      <h3 style="text-align:center;">RELAT√ìRIO PRODUTIVIDADE ${String(num).padStart(3,'0')}/${ano}</h3>
      <p><strong>DE:</strong> Diretoria de Fiscaliza√ß√£o e Tributa√ß√£o<br>
      <strong>PARA:</strong> Secretaria da Fazenda<br>
      <strong>ASSUNTO:</strong> Produtividade Fiscal<br>
      <strong>DATA:</strong> ${dataGer}</p>
      <p style="margin-top:12px;">Em resposta √† solicita√ß√£o, segue planilha das atividades realizadas neste setor entre <strong>${periodo}</strong>:</p>
      <table style="width:100%;border-collapse:collapse;margin-top:10px;">
        ${Object.entries(resumo).map(([serv,q])=>`
          <tr>
            <td style="border-bottom:1px dotted #999;padding:4px 6px;">${serv}</td>
            <td style="text-align:right;border-bottom:1px dotted #999;padding:4px 6px;">${q}</td>
          </tr>`).join('')}
      </table>
      <p style="margin-top:20px;"><strong>Valor arrecadado no per√≠odo:</strong> ${totalBRL}</p>
      <p style="margin-top:20px;">Sendo o que temos para o momento, nos colocamos √† disposi√ß√£o para maiores esclarecimentos.</p>
      <p style="margin-top:40px;text-align:center;">Atenciosamente,<br><br><strong>Ger√™ncia de Fiscaliza√ß√£o Tribut√°ria</strong><br>Prefeitura Municipal de Diamantina/MG</p>
      <hr style="margin:30px 0;">
      <p style="text-align:center;font-size:12px;margin-top:30px;">
        <strong>Data de gera√ß√£o:</strong> ${dataGer}<br>
        <strong>Gerente:</strong> ${gerente}
      </p>
    </div>`;

    html2pdf().set({
      margin: [5,10,10,10],
      filename: `Relatorio_${String(num).padStart(3,'0')}_${ano}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(relatorio).save();
  };

  // Gest√£o de Usu√°rios + Importa√ß√£o XLSX permanecem iguais
  // (mantidos da tua vers√£o anterior ‚Äî n√£o alterei essa parte)
  // ...
  (function init(){
    setPeriodo(7);
    filtrar();
  })();
</script>
</body>
</html>
