<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerente ‚Äî Sistema de Produ√ß√£o Tribut√°rio</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;
      --primary:#2563eb;--primary-ink:#fff;--border:#e5e7eb;
      --good:#16a34a;--bad:#dc2626;--chip:#eef2ff;--chip-ink:#1e40af;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .header{
      position:fixed;top:0;left:0;right:0;z-index:50;
      background:#fff;border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;padding:12px 16px;
    }
    .header .title{font-weight:700}
    .header .sub{color:var(--muted);font-size:14px}
    .header .right{margin-left:auto;display:flex;align-items:center;gap:10px}
    .btn-ghost{background:#eef2ff;color:#1e40af;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600}
    .who-badge{background:#f3f4f6;color:#111827;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600}

    .wrap{max-width:1150px;margin:0 auto;padding:98px 16px 24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 14px rgba(17,24,39,.05);margin-bottom:16px;overflow:hidden}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .card .bd{padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{font:inherit}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    button{padding:10px 14px;border:0;border-radius:10px;background:var(--primary);color:var(--primary-ink);cursor:pointer;font-weight:600}
    button.pill{background:var(--chip);color:var(--chip-ink);border:0;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:600;font-size:13px}
    .form-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .table-wrap{overflow-x:auto;overflow-y:auto;max-height:400px;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;white-space:nowrap}
    thead th{background:#f3f4f6;color:var(--muted);font-weight:600}
    tbody tr:nth-child(even){background:#f9fafb}
    h3{margin-top:20px;margin-bottom:8px;font-size:16px}
    #modalUser{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:100}
    #modalUser .box{background:#fff;padding:20px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .msg.ok{color:var(--good)}.msg.err{color:var(--bad)}

    /* === Novo layout do painel de resumos e gr√°fico === */
    #painelResumo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      align-items: start;
      margin-top: 16px;
    }
    #painelResumo .card { margin-bottom: 0; }
    #graficoResumo { width:100%; height:280px; }
  </style>
</head>
<body>
  <header class="header">
    <div>
      <div class="title">Sistema de Produ√ß√£o Tribut√°rio ‚Äî Painel do Gerente</div>
      <div class="sub">Relat√≥rios e gest√£o de usu√°rios</div>
    </div>
    <div class="right">
      <span id="who" class="who-badge">Conectando‚Ä¶</span>
      <button id="btnSair" class="btn-ghost">Sair</button>
    </div>
  </header>

  <div class="wrap">
    <div id="msg" class="msg"></div>

    <!-- RELAT√ìRIOS -->
    <div class="card">
      <div class="hd"><span>Relat√≥rio por per√≠odo</span></div>
      <div class="bd">
        <div class="form-grid">
          <div><label>De</label><input id="dIni" type="date"></div>
          <div><label>At√©</label><input id="dFim" type="date"></div>
          <div style="align-self:end"><button id="btnFiltrar">Filtrar</button></div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center">
            <span class="pill" style="pointer-events:none">Atalhos:</span>
            <button class="pill" id="pSem">Semanal</button>
            <button class="pill" id="pQzn">Quinzenal</button>
            <button class="pill" id="pMns">Mensal</button>
          </div>
        </div>

        <div class="table-wrap" style="margin-top:16px">
          <table id="tabLanc" class="table">
            <thead><tr><th>Data</th><th>Fiscal</th><th>Empresa</th><th>Descri√ß√£o</th><th>Qtd</th><th>Valor</th><th>Destino</th><th>Resumo</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px">
          <div><strong>Total registros:</strong> <span id="tRegs">0</span></div>
          <div><strong>Total Quantidade:</strong> <span id="tQtd">0</span></div>
          <div><strong>Total Valor:</strong> <span id="tVal">R$ 0,00</span></div>
        </div>

        <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <label for="numRel" style="font-weight:600;">N¬∫ Relat√≥rio:</label>
          <input id="numRel" type="number" min="1" placeholder="(autom√°tico)" style="width:120px">
          <button id="btnPDF" class="pill" style="background:#10b981;color:#fff">üñ®Ô∏è Gerar PDF</button>
        </div>

        <!-- Painel de resumos + gr√°fico -->
        <div id="painelResumo">
          <div class="card">
            <div class="hd">Resumo por Fiscal</div>
            <div class="bd" id="resFiscal"></div>
          </div>
          <div class="card">
            <div class="hd">Resumo por Tipo de Servi√ßo</div>
            <div class="bd" id="resTipo"></div>
          </div>
          <div class="card">
            <div class="hd">Composi√ß√£o do Valor Arrecadado</div>
            <div class="bd"><canvas id="graficoResumo"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- GEST√ÉO DE USU√ÅRIOS -->
    <div class="card">
      <div class="hd">
        <span>Gest√£o de Usu√°rios (Fiscais e Gerentes)</span>
        <button id="btnNovoUser" class="pill">‚ûï Novo Usu√°rio</button>
      </div>
      <div class="bd">
        <div class="table-wrap">
          <table id="tabUsers" class="table">
            <thead><tr><th>Nome</th><th>Tipo</th><th>Senha</th><th>A√ß√µes</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Usu√°rio -->
  <div id="modalUser">
    <div class="box">
      <h3 id="modalTitulo">Novo Usu√°rio</h3>
      <div style="display:grid;gap:10px;margin-top:10px">
        <div><label>Nome</label><input id="uNome" type="text"></div>
        <div><label>Senha</label><input id="uSenha" type="password"></div>
        <div><label>Tipo</label>
          <select id="uTipo">
            <option value="fiscal">Fiscal</option>
            <option value="gerente">Gerente</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
          <button id="btnSalvarUser">Salvar</button>
          <button id="btnCancelarUser" class="btn-ghost">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { gerarPDF } from "./relatorio.js";
    import { inicializarUsuarios } from "./usuarios.js";
    import { gerarGraficoResumo } from "./graficoResumo.js";

    const firebaseConfig = {
      apiKey:"AIzaSyANrr4R5JtJ9GmO0j-1X8-9CvBmYkC4oCI",
      authDomain:"fiscalizacao9557.firebaseapp.com",
      projectId:"fiscalizacao9557",
      storageBucket:"fiscalizacao9557.firebasestorage.app",
      messagingSenderId:"98041336495",
      appId:"1:98041336495:web:0475dfd9c0490cc0a17a5a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = s=>document.querySelector(s);
    const numberToBRL = n=>Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    let sess=null;
    try{ sess=JSON.parse(localStorage.getItem('sessao_usuario')||'null'); }catch(e){ sess=null; }
    if(!sess || sess.tipo!=='gerente'){ location.href='index.html'; }
    $('#who').textContent=`${sess.nome} (Gerente)`;
    $('#btnSair').onclick=()=>{ localStorage.removeItem('sessao_usuario'); location.href='index.html'; };

    let cacheLanc=[];
    async function filtrar(){
      const dIni=$('#dIni').value, dFim=$('#dFim').value;
      if(!dIni||!dFim)return;
      const qLanc=query(collection(db,'lancamentos'),
        where('data','>=',dIni),
        where('data','<=',dFim),
        orderBy('data','asc')
      );
      const snap=await getDocs(qLanc);
      cacheLanc=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderLanc(cacheLanc);
    }

    function renderLanc(rows){
      const tb=$('#tabLanc tbody'); tb.innerHTML='';
      let tRegs=0,tQtd=0,tVal=0;
      const porFiscal=new Map(), porTipo=new Map();
      rows.forEach(r=>{
        tRegs++; tQtd+=Number(r.quantidade||0); tVal+=Number(r.valor||0);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.data||''}</td><td>${r.usuario||''}</td><td>${r.empresa||''}</td><td>${r.descricao||''}</td>
          <td>${r.quantidade||0}</td><td>${r.valor?numberToBRL(r.valor):''}</td><td>${r.destino||''}</td><td>${r.descricaoResumida||''}</td>`;
        tb.appendChild(tr);
        porFiscal.set(r.usuario,(porFiscal.get(r.usuario)||0)+Number(r.quantidade||0));
        porTipo.set(r.descricaoResumida,(porTipo.get(r.descricaoResumida)||0)+Number(r.quantidade||0));
      });
      $('#tRegs').textContent=tRegs;
      $('#tQtd').textContent=tQtd;
      $('#tVal').textContent=numberToBRL(tVal);
      $('#resFiscal').innerHTML=Array.from(porFiscal.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('')||'<em>‚Äî</em>';
      $('#resTipo').innerHTML=Array.from(porTipo.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('')||'<em>‚Äî</em>';

      // Atualiza o gr√°fico sempre que renderizar
      gerarGraficoResumo(rows);
    }

    $('#btnFiltrar').onclick=filtrar;
    $('#btnPDF').onclick=()=>gerarPDF(cacheLanc,sess,$('#dIni').value,$('#dFim').value,$('#numRel').value);

    (function init(){
      const fim=new Date(), ini=new Date(); ini.setDate(ini.getDate()-7);
      $('#dIni').value=ini.toISOString().slice(0,10);
      $('#dFim').value=fim.toISOString().slice(0,10);
      filtrar();
      inicializarUsuarios(db);
    })();
  </script>
</body>
</html>
