<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gerente — Sistema de Produção Tributário</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#f6f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;
  --primary:#2563eb;--primary-ink:#fff;--border:#e5e7eb;
}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:100px auto;padding:0 16px}
.card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:20px}
h3{margin:20px 0 8px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;text-align:left}
thead{background:#f3f4f6}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Painel do Gerente</h2>

    <label>De <input id="dIni" type="date"></label>
    <label>Até <input id="dFim" type="date"></label>
    <button id="btnFiltrar">Filtrar</button>

    <div class="table-wrap" style="margin-top:16px;max-height:300px;overflow:auto;">
      <table id="tabLanc">
        <thead><tr><th>Data</th><th>Descrição</th><th>Valor</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="text-align:center">Composição do Valor Arrecadado</h3>
    <canvas id="graficoComposicao" width="600" height="250"></canvas>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyANrr4R5JtJ9GmO0j-1X8-9CvBmYkC4oCI",
  authDomain:"fiscalizacao9557.firebaseapp.com",
  projectId:"fiscalizacao9557",
  storageBucket:"fiscalizacao9557.firebasestorage.app",
  messagingSenderId:"98041336495",
  appId:"1:98041336495:web:0475dfd9c0490cc0a17a5a"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const $=s=>document.querySelector(s);
const numberToBRL=n=>Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
let cache=[];

async function filtrar(){
  const ini=new Date($('#dIni').value+"T00:00:00");
  const fim=new Date($('#dFim').value+"T23:59:59");
  const snap=await getDocs(query(collection(db,"lancamentos"),orderBy("data","asc")));
  const dados=[];
  snap.forEach(doc=>{
    const r=doc.data();
    const dt=r.data?.toDate?r.data.toDate():new Date(r.data);
    if(dt>=ini && dt<=fim){
      dados.push({...r,data:dt.toLocaleDateString('pt-BR')});
    }
  });
  cache=dados;
  renderTabela(dados);
  gerarGrafico(dados);
}

function renderTabela(rows){
  const tb=$("#tabLanc tbody");tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.data}</td><td>${r.descricaoResumida||r.descricao||''}</td><td>${r.valor?numberToBRL(r.valor):''}</td>`;
    tb.appendChild(tr);
  });
}

function gerarGrafico(rows){
  const canvas=document.getElementById('graficoComposicao');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  if(window.graficoAtual){window.graficoAtual.destroy();}

  let totalISS=0,totalTFLF=0,totalOutros=0;
  rows.forEach(r=>{
    const tipo=(r.descricaoResumida||'').toLowerCase();
    const valor=Number(r.valor||0);
    if(tipo.includes('lançamento de tributo')||tipo.includes('emissão de guia de issqn')) totalISS+=valor;
    else if(tipo.includes('apuração de tflf')) totalTFLF+=valor;
    else totalOutros+=valor;
  });

  window.graficoAtual=new Chart(ctx,{
    type:'bar',
    data:{
      labels:['ISSQN','TFLF','Outros'],
      datasets:[{
        label:'Valor arrecadado (R$)',
        data:[totalISS,totalTFLF,totalOutros],
        backgroundColor:['#2563eb','#16a34a','#6b7280']
      }]
    },
    options:{
      indexAxis:'y',
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{beginAtZero:true,ticks:{callback:v=>'R$ '+v.toLocaleString('pt-BR')}},
        y:{ticks:{font:{weight:'600'}}}
      }
    }
  });
}

$('#btnFiltrar').onclick=filtrar;

(function init(){
  const fim=new Date(),ini=new Date();ini.setDate(ini.getDate()-7);
  $('#dIni').value=ini.toISOString().slice(0,10);
  $('#dFim').value=fim.toISOString().slice(0,10);
  filtrar();
})();
</script>
</body>
</html>
