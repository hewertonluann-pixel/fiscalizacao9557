<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerente ‚Äî Sistema de Produ√ß√£o Tribut√°rio</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;
      --primary:#2563eb;--primary-ink:#fff;--border:#e5e7eb;
      --good:#16a34a;--bad:#dc2626;--chip:#eef2ff;--chip-ink:#1e40af;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .header{
      position:fixed;top:0;left:0;right:0;z-index:50;
      background:#fff;border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;padding:12px 16px;
    }
    .header .title{font-weight:700}
    .header .sub{color:var(--muted);font-size:14px}
    .header .right{margin-left:auto;display:flex;align-items:center;gap:10px}
    .btn-ghost{background:#eef2ff;color:#1e40af;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600}
    .who-badge{background:#f3f4f6;color:#111827;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600}
    .wrap{max-width:1150px;margin:0 auto;padding:98px 16px 24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 14px rgba(17,24,39,.05);margin-bottom:16px;overflow:hidden}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .card .bd{padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{font:inherit}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    button{padding:10px 14px;border:0;border-radius:10px;background:var(--primary);color:var(--primary-ink);cursor:pointer;font-weight:600}
    button.pill{background:var(--chip);color:var(--chip-ink);border:0;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:600;font-size:13px}
    .form-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .table-wrap{overflow-x:auto;overflow-y:auto;max-height:400px;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;white-space:nowrap}
    thead th{background:#f3f4f6;color:var(--muted);font-weight:600}
    tbody tr:nth-child(even){background:#f9fafb}
    h3{margin-top:20px;margin-bottom:8px;font-size:16px}
  </style>
</head>
<body>
  <header class="header">
    <div>
      <div class="title">Sistema de Produ√ß√£o Tribut√°rio ‚Äî Painel do Gerente</div>
      <div class="sub">Relat√≥rios e gest√£o de usu√°rios</div>
    </div>
    <div class="right">
      <span id="who" class="who-badge">Conectando‚Ä¶</span>
      <button id="btnSair" class="btn-ghost">Sair</button>
    </div>
  </header>

  <div class="wrap">
    <div id="msg" class="msg"></div>

    <!-- RELAT√ìRIOS -->
    <div class="card">
      <div class="hd"><span>Relat√≥rio por per√≠odo</span></div>
      <div class="bd">
        <div class="form-grid">
          <div><label>De</label><input id="dIni" type="date"></div>
          <div><label>At√©</label><input id="dFim" type="date"></div>
          <div style="align-self:end"><button id="btnFiltrar">Filtrar</button></div>
        </div>

        <div class="table-wrap" style="margin-top:16px">
          <table id="tabLanc" class="table">
            <thead><tr><th>Data</th><th>Fiscal</th><th>Empresa</th><th>Descri√ß√£o</th><th>Qtd</th><th>Valor</th><th>Destino</th><th>Resumo</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px">
          <div><strong>Total registros:</strong> <span id="tRegs">0</span></div>
          <div><strong>Total Quantidade:</strong> <span id="tQtd">0</span></div>
          <div><strong>Total Valor:</strong> <span id="tVal">R$ 0,00</span></div>
        </div>

        <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <label for="numRel" style="font-weight:600;">N¬∫ Relat√≥rio:</label>
          <input id="numRel" type="number" min="1" placeholder="(autom√°tico)" style="width:120px">
          <button id="btnPDF" class="pill" style="background:#10b981;color:#fff">üñ®Ô∏è Gerar PDF</button>
        </div>

        <!-- Resumos e gr√°fico lado a lado -->
        <div style="display:flex;gap:24px;align-items:flex-start;flex-wrap:wrap;margin-top:24px;">
          <div style="flex:1;min-width:320px;">
            <h3>Resumo por Fiscal</h3>
            <div id="resFiscal"></div>
            <h3>Resumo por Tipo de Servi√ßo</h3>
            <div id="resTipo"></div>
          </div>
          <div style="flex:1;min-width:320px;max-width:520px;">
            <h3 style="text-align:center;">Composi√ß√£o do Valor Arrecadado</h3>
            <canvas id="graficoComposicao" width="400" height="260"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- GEST√ÉO DE USU√ÅRIOS -->
    <div class="card">
      <div class="hd">
        <span>Gest√£o de Usu√°rios (Fiscais e Gerentes)</span>
        <button id="btnNovoUser" class="pill">‚ûï Novo Usu√°rio</button>
      </div>
      <div class="bd">
        <div class="table-wrap">
          <table id="tabUsers" class="table">
            <thead><tr><th>Nome</th><th>Tipo</th><th>Senha</th><th>A√ß√µes</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { gerarPDF } from "./relatorio.js";
    import { inicializarUsuarios } from "./usuarios.js";

    const firebaseConfig = {
      apiKey:"AIzaSyANrr4R5JtJ9GmO0j-1X8-9CvBmYkC4oCI",
      authDomain:"fiscalizacao9557.firebaseapp.com",
      projectId:"fiscalizacao9557",
      storageBucket:"fiscalizacao9557.firebasestorage.app",
      messagingSenderId:"98041336495",
      appId:"1:98041336495:web:0475dfd9c0490cc0a17a5a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = s=>document.querySelector(s);
    const numberToBRL = n=>Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    let sess=null;
    try{ sess=JSON.parse(localStorage.getItem('sessao_usuario')||'null'); }catch(e){ sess=null; }
    if(!sess || sess.tipo!=='gerente'){ location.href='index.html'; }
    $('#who').textContent=`${sess.nome} (Gerente)`;
    $('#btnSair').onclick=()=>{ localStorage.removeItem('sessao_usuario'); location.href='index.html'; };

    let cacheLanc=[];
    async function filtrar(){
      const dIni=new Date($('#dIni').value+"T00:00:00");
      const dFim=new Date($('#dFim').value+"T23:59:59");
      const qLanc=query(collection(db,'lancamentos'),orderBy('data','asc'));
      const snap=await getDocs(qLanc);
      const dados=[];
      snap.forEach(doc=>{
        const r=doc.data();
        const dataReg=r.data?.toDate?r.data.toDate():new Date(r.data);
        if(dataReg>=dIni && dataReg<=dFim){
          r.data=dataReg.toLocaleDateString('pt-BR');
          dados.push(r);
        }
      });
      cacheLanc=dados;
      renderLanc(cacheLanc);
      gerarGrafico(cacheLanc);
    }

    function renderLanc(rows){
      const tb=$('#tabLanc tbody'); tb.innerHTML='';
      let tRegs=0,tQtd=0,tVal=0;
      const porFiscal=new Map(), porTipo=new Map();
      rows.forEach(r=>{
        tRegs++; tQtd+=Number(r.quantidade||0); tVal+=Number(r.valor||0);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.data||''}</td><td>${r.usuario||''}</td><td>${r.empresa||''}</td><td>${r.descricao||''}</td>
          <td>${r.quantidade||0}</td><td>${r.valor?numberToBRL(r.valor):''}</td><td>${r.destino||''}</td><td>${r.descricaoResumida||''}</td>`;
        tb.appendChild(tr);
        porFiscal.set(r.usuario,(porFiscal.get(r.usuario)||0)+Number(r.quantidade||0));
        porTipo.set(r.descricaoResumida,(porTipo.get(r.descricaoResumida)||0)+Number(r.quantidade||0));
      });
      $('#tRegs').textContent=tRegs;
      $('#tQtd').textContent=tQtd;
      $('#tVal').textContent=numberToBRL(tVal);
      $('#resFiscal').innerHTML=Array.from(porFiscal.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('')||'<em>‚Äî</em>';
      $('#resTipo').innerHTML=Array.from(porTipo.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('')||'<em>‚Äî</em>';
    }

    function gerarGrafico(rows){
      const ctx=document.getElementById('graficoComposicao').getContext('2d');
      if(window.graficoAtual){window.graficoAtual.destroy();}
      let totalISS=0,totalTFLF=0,totalOutros=0;
      rows.forEach(r=>{
        const tipo=(r.descricaoResumida||'').toLowerCase();
        const valor=Number(r.valor||0);
        if(tipo.includes('lan√ßamento de tributo')||tipo.includes('emiss√£o de guia de issqn')) totalISS+=valor;
        else if(tipo.includes('apura√ß√£o de tflf')) totalTFLF+=valor;
        else totalOutros+=valor;
      });
      window.graficoAtual=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['ISSQN','TFLF','Outros'],
          datasets:[{
            label:'Valor arrecadado (R$)',
            data:[totalISS,totalTFLF,totalOutros],
            backgroundColor:['#2563eb','#16a34a','#6b7280']
          }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{
            x:{beginAtZero:true,ticks:{callback:v=>'R$ '+v.toLocaleString('pt-BR')}},
            y:{ticks:{font:{weight:'600'}}}
          }
        }
      });
    }

    $('#btnFiltrar').onclick=filtrar;
    $('#btnPDF').onclick=()=>gerarPDF(cacheLanc,sess,$('#dIni').value,$('#dFim').value,$('#numRel').value);

    (function init(){
      const fim=new Date(), ini=new Date(); ini.setDate(ini.getDate()-7);
      $('#dIni').value=ini.toISOString().slice(0,10);
      $('#dFim').value=fim.toISOString().slice(0,10);
      filtrar();
      inicializarUsuarios(db);
    })();
  </script>
</body>
</html>
