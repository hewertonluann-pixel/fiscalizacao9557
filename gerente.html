<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerente ‚Äî Sistema de Produ√ß√£o</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Painel do Gerente</h1>
  <div class="sub">
    Relat√≥rios e gest√£o de usu√°rios.
    <span id="who"></span> |
    <button id="btnSair" class="link">Sair</button>
  </div>

  <div id="msg" class="msg"></div>

  <!-- =================== RELAT√ìRIOS =================== -->
  <div class="card">
    <div class="hd">
      <span>Relat√≥rio por per√≠odo</span>
      <div class="form-grid">
        <div><label>De</label><input id="dIni" type="date"></div>
        <div><label>At√©</label><input id="dFim" type="date"></div>
        <div><label>&nbsp;</label><button id="btnFiltrar">Filtrar</button></div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="pill">Atalhos:</span>
          <button class="pill" id="pSem">Semanal</button>
          <button class="pill" id="pQzn">Quinzenal</button>
          <button class="pill" id="pMns">Mensal</button>
        </div>
      </div>
    </div>

    <div class="bd">
      <div class="scroll table-wrap">
        <table id="tabLanc" class="table">
          <thead>
            <tr>
              <th>Data</th><th>Fiscal</th><th>Empresa</th><th>Descri√ß√£o</th>
              <th>Qtd</th><th>Valor</th><th>Destino</th><th>Resumo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px">
        <div><strong>Total registros:</strong> <span id="tRegs">0</span></div>
        <div><strong>Total Quantidade:</strong> <span id="tQtd">0</span></div>
        <div><strong>Total Valor:</strong> <span id="tVal">R$ 0,00</span></div>
      </div>

      <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <label for="numRel" style="font-weight:600;">N¬∫ Relat√≥rio:</label>
        <input id="numRel" type="number" min="1" placeholder="(autom√°tico)" style="width:120px;padding:6px 8px;border:1px solid #ccc;border-radius:6px;">
        <button id="btnPDF" class="pill" style="background:#10b981;color:#fff">üñ®Ô∏è Gerar Relat√≥rio PDF (modelo oficial)</button>
      </div>

      <div style="margin-top:20px">
        <h3>Resumo por Fiscal</h3>
        <div id="resFiscal"></div>
        <h3>Resumo por Tipo de Servi√ßo</h3>
        <div id="resTipo"></div>
      </div>
    </div>
  </div>

  <!-- =================== GEST√ÉO DE USU√ÅRIOS =================== -->
  <div class="card">
    <div class="hd">
      <span>Gest√£o de usu√°rios (Fiscais e Gerentes)</span>
      <button id="btnNovo" class="pill">‚ûï Novo Usu√°rio</button>
    </div>
    <div class="bd">
      <div class="scroll table-wrap">
        <table id="tabUsers" class="table">
          <thead><tr><th>Nome</th><th>Tipo</th><th>Senha</th><th>A√ß√µes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <div class="form-grid">
        <div>
          <label>Importar planilhas (.xlsx) por Fiscal (nome-do-fiscal-*.xlsx)</label>
          <input id="fileInput" type="file" multiple accept=".xlsx,.xls">
        </div>
        <div><button id="btnImportar">Importar</button></div>
        <pre id="importLog" style="white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>
</div>

<!-- =================== MODAL USU√ÅRIO =================== -->
<div id="modalUser" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;">
  <div style="background:#fff;padding:20px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 4px 12px rgba(0,0,0,.3);">
    <h3 id="modalTitulo">Novo Usu√°rio</h3>
    <div style="display:grid;gap:10px;margin-top:10px">
      <div><label>Nome</label><input id="uNome" type="text"></div>
      <div><label>Senha</label><input id="uSenha" type="password"></div>
      <div><label>Tipo</label>
        <select id="uTipo">
          <option value="fiscal">Fiscal</option>
          <option value="gerente">Gerente</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button id="btnSalvarUser">Salvar</button>
        <button id="btnCancelarUser" class="ghost">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- =================== SCRIPT PRINCIPAL =================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyANrr4R5JtJ9GmO0j-1X8-9CvBmYkC4oCI",
  authDomain: "fiscalizacao9557.firebaseapp.com",
  projectId: "fiscalizacao9557",
  storageBucket: "fiscalizacao9557.firebasestorage.app",
  messagingSenderId: "98041336495",
  appId: "1:98041336495:web:0475dfd9c0490cc0a17a5a",
  measurementId: "G-7PY1G1JTKL"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = s => document.querySelector(s);
const numberToBRL = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const showMsg = (t,c='ok')=>{ const m=$('#msg'); m.textContent=t; m.className='msg '+c; m.style.display='block'; setTimeout(()=>m.style.display='none',2500); };

// ================= Sess√£o =================
let sess=null;
function validarSessao(){
  try{ sess = JSON.parse(localStorage.getItem('sessao_usuario')||'null'); }catch(e){ sess=null; }
  if(!sess || sess.tipo!=='gerente'){ location.href='index.html'; return; }
  $('#who').textContent = `${sess.nome} (Gerente)`;
}
validarSessao();
$('#btnSair').onclick = ()=>{ localStorage.removeItem('sessao_usuario'); location.href='index.html'; };

// ================= Atalhos de Per√≠odo =================
function setPeriodo(dias){
  const fim=new Date(), ini=new Date(); ini.setDate(ini.getDate()-dias+1);
  $('#dIni').value = ini.toISOString().slice(0,10);
  $('#dFim').value = fim.toISOString().slice(0,10);
}
$('#pSem').onclick=()=>{ setPeriodo(7); filtrar(); };
$('#pQzn').onclick=()=>{ setPeriodo(15); filtrar(); };
$('#pMns').onclick=()=>{ setPeriodo(30); filtrar(); };
$('#btnFiltrar').onclick=filtrar;

// ================= Filtrar Lan√ßamentos =================
async function filtrar(){
  const dIni = $('#dIni').value || null;
  const dFim = $('#dFim').value || null;
  if(!dIni || !dFim){ showMsg('Informe De e At√©.','err'); return; }

  const qLanc = query(
    collection(db,'lancamentos'),
    where('data','>=', dIni),
    where('data','<=', dFim),
    orderBy('data','asc')
  );
  const snap = await getDocs(qLanc);
  const rows = [];
  snap.forEach(d=> rows.push({ id:d.id, ...d.data() }) );
  renderLanc(rows);
}

function renderLanc(rows){
  const tb=$('#tabLanc tbody'); tb.innerHTML='';
  let tRegs=0,tQtd=0,tVal=0;
  const porFiscal=new Map(), porTipo=new Map();

  rows.forEach(r=>{
    tRegs++; tQtd += Number(r.quantidade||0); tVal += Number(r.valor||0);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.data||''}</td><td>${r.usuario||''}</td><td>${r.empresa||''}</td><td>${r.descricao||''}</td>
                    <td>${r.quantidade||0}</td><td>${r.valor?numberToBRL(r.valor):''}</td><td>${r.destino||''}</td><td>${r.descricaoResumida||''}</td>`;
    tb.appendChild(tr);
    porFiscal.set(r.usuario,(porFiscal.get(r.usuario)||0)+Number(r.quantidade||0));
    porTipo.set(r.descricaoResumida,(porTipo.get(r.descricaoResumida)||0)+Number(r.quantidade||0));
  });

  $('#tRegs').textContent=tRegs;
  $('#tQtd').textContent=tQtd;
  $('#tVal').textContent=numberToBRL(tVal);
  $('#resFiscal').innerHTML = Array.from(porFiscal.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('') || '<em>‚Äî</em>';
  $('#resTipo').innerHTML = Array.from(porTipo.entries()).map(([k,v])=>`<div>‚Ä¢ <strong>${k}:</strong> ${v}</div>`).join('') || '<em>‚Äî</em>';
}

// ================= PDF CORRIGIDO =================
$('#btnPDF').onclick = () => {
  const dIni = $('#dIni').value;
  const dFim = $('#dFim').value;
  const tBody = $('#tabLanc tbody');
  if (!tBody.children.length) { alert('Nenhum lan√ßamento no per√≠odo.'); return; }

  const resumoTipo = {};
  Array.from(tBody.children).forEach(tr=>{
    const serv = tr.children[7].textContent.trim();
    const qtd = parseInt(tr.children[4].textContent.trim() || '0',10);
    resumoTipo[serv] = (resumoTipo[serv]||0) + qtd;
  });

  let totalArrec = 0;
  Array.from(tBody.children).forEach(tr=>{
    const valTxt = tr.children[5].textContent.trim().replace(/[R$\.\s]/g,'').replace(',','.');
    totalArrec += parseFloat(valTxt||'0')||0;
  });

  const hoje = new Date();
  const dataGer = hoje.toLocaleDateString('pt-BR');
  const ano = hoje.getFullYear();
  let numInput = parseInt($('#numRel')?.value.trim() || '0',10);
  let num = numInput > 0 ? numInput : (Number(localStorage.getItem('numero_relatorio')||'0') + 1);
  if (numInput <= 0) localStorage.setItem('numero_relatorio', num);

  const relatorio = `
  <div style="font-family:Arial;width:100%;max-width:650px;margin:0 auto;padding:0;line-height:1.6;word-wrap:break-word;box-sizing:border-box;">
    <h3 style="text-align:center;margin:0;">PREFEITURA MUNICIPAL DE DIAMANTINA</h3>
    <h4 style="text-align:center;margin:0;">SECRETARIA MUNICIPAL DE FAZENDA</h4>
    <h4 style="text-align:center;margin:0;">Diretoria de Fiscaliza√ß√£o e Tributa√ß√£o</h4>
    <hr style="margin:10px 0;">
    <h3 style="text-align:center;margin:0;">RELAT√ìRIO PRODUTIVIDADE ${String(num).padStart(3,'0')}/${ano}</h3>
    <p style="margin:8px 0 0 0;">
      <strong>DE:</strong> Diretoria de Fiscaliza√ß√£o e Tributa√ß√£o<br>
      <strong>PARA:</strong> Secretaria da Fazenda<br>
      <strong>ASSUNTO:</strong> Produtividade Fiscal<br>
      <strong>DATA:</strong> ${dataGer}
    </p>
    <p style="margin-top:12px;">
      Atividades realizadas entre <strong>${new Date(dIni+'T00:00:00').toLocaleDateString('pt-BR')}</strong> e <strong>${new Date(dFim+'T00:00:00').toLocaleDateString('pt-BR')}</strong>:
    </p>
    <table style="width:100%;border-collapse:collapse;margin-top:10px;">
      ${Object.entries(resumoTipo).map(([serv,q])=>`
        <tr>
          <td style="border-bottom:1px dotted #999;padding:4px 6px;">${serv}</td>
          <td style="text-align:right;border-bottom:1px dotted #999;padding:4px 6px;">${q}</td>
        </tr>`).join('')}
    </table>
    <p style="margin-top:20px;"><strong>Valor arrecadado no per√≠odo:</strong> ${numberToBRL(totalArrec)}</p>
    <p style="margin-top:20px;">Sendo o que temos para o momento, nos colocamos √† disposi√ß√£o para maiores esclarecimentos.</p>
    <p style="margin-top:40px;text-align:center;">Atenciosamente,<br><br><strong>Ger√™ncia de Fiscaliza√ß√£o Tribut√°ria</strong><br>Prefeitura Municipal de Diamantina/MG</p>
    <hr style="margin:25px 0;">
    <p style="text-align:center;font-size:12px;margin-top:20px;">
      <strong>Data de gera√ß√£o:</strong> ${dataGer}<br>
      <strong>Gerente:</strong> ${sess.nome}
    </p>
  </div>`;

  html2pdf().set({
    margin: [10,10,10,10],
    pagebreak: { mode: ['avoid-all'] },
    filename: `Relatorio_${String(num).padStart(3,'0')}_${ano}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 1.4, useCORS: true, scrollY: 0, windowWidth: 900 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).from(relatorio).save();
};

// ================= Usu√°rios =================
let editUserId = null;
$('#btnNovo').onclick=()=>{ $('#modalUser').style.display='flex'; $('#modalTitulo').textContent='Novo Usu√°rio'; $('#uNome').value=''; $('#uSenha').value=''; $('#uTipo').value='fiscal'; editUserId=null; };
$('#btnCancelarUser').onclick=()=>$('#modalUser').style.display='none';

$('#btnSalvarUser').onclick=async ()=>{ const nome=$('#uNome').value.trim(); const senha=$('#uSenha').value.trim(); const tipo=$('#uTipo').value;
  if(!nome||!senha){showMsg('Preencha nome e senha','err');return;}
  try{ if(!editUserId){ await addDoc(collection(db,'usuarios'),{nome,nomeLower:nome.toLowerCase(),senha,tipo}); showMsg('Usu√°rio adicionado','ok'); }
  else{ await updateDoc(doc(db,'usuarios',editUserId),{nome,nomeLower:nome.toLowerCase(),senha,tipo}); showMsg('Usu√°rio atualizado','ok'); }
  $('#modalUser').style.display='none'; carregarUsuarios(); }
  catch(e){ console.error(e); showMsg('Erro ao salvar usu√°rio','err'); }};

async function carregarUsuarios(){
  const snap = await getDocs(collection(db,'usuarios'));
  const tb=$('#tabUsers tbody'); tb.innerHTML='';
  snap.forEach(d=>{
    const u=d.data();
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${u.nome}</td><td>${u.tipo}</td><td>${u.senha}</td>
    <td style="white-space:nowrap">
      <button data-e="${d.id}" class="link">‚úèÔ∏è</button>
      <button data-x="${d.id}" class="link" style="color:#dc2626">‚ùå</button>
    </td>`;
    tb.appendChild(tr);
  });

  tb.querySelectorAll('[data-e]').forEach(b=>{
    b.onclick=async ()=>{ const id=b.getAttribute('data-e'); editUserId=id;
      const all=await getDocs(query(collection(db,'usuarios'),where('__name__','==',id)));
      if(!all.empty){ const u=all.docs[0].data(); $('#modalUser').style.display='flex'; $('#modalTitulo').textContent='Editar Usu√°rio';
        $('#uNome').value=u.nome; $('#uSenha').value=u.senha; $('#uTipo').value=u.tipo; }};
  });

  tb.querySelectorAll('[data-x]').forEach(b=>{
    b.onclick=async ()=>{ const id=b.getAttribute('data-x'); if(confirm('Excluir este usu√°rio?')){
      await deleteDoc(doc(db,'usuarios',id)); showMsg('Usu√°rio removido','ok'); carregarUsuarios(); }};
  });
}
carregarUsuarios();

</script>
</body>
</html>
